import { promises as fs } from 'fs';
import path from 'path';
import { ParserRegistry } from '../parsers/parser-registry.js';
import { IgnoreFilter } from '../utils/ignore-filter.js';
import { ExcelReporter } from '../reporters/excel-reporter.js';
import { NotifierRegistry } from '../notifiers/notifier-registry.js';
import { ConfigLoader } from '../utils/config-loader.js';
import { ResultLogger } from '../utils/result-logger.js';
import type { CliOptions } from '../types.js';
import { normalizeOptions } from '../utils/normalizeOptions.js';

export class VulnerabilityProcessor {
  async processReport(_options: CliOptions): Promise<boolean> {
    const options = normalizeOptions(_options);
    console.log('ğŸ” é–‹å§‹è™•ç†æ¼æ´æƒæå ±å‘Š...');

    // 1. è®€å–ä¸¦è§£ææƒæå ±å‘Š
    console.log('ğŸ“– è®€å–æƒæå ±å‘Šæª”æ¡ˆ...');
    const reportContent = await fs.readFile(options.input, 'utf-8');
    const reportData = JSON.parse(reportContent);

    // 2. åˆå§‹åŒ–è§£æå™¨è¨»å†Šè¡¨
    const parserRegistry = new ParserRegistry();

    // 3. è‡ªå‹•æª¢æ¸¬æˆ–æ‰‹å‹•æŒ‡å®šè§£æå™¨
    let parserResult;
    if (options.scanner !== 'auto') {
      const parser = parserRegistry.getParser(options.scanner);
      if (!parser) {
        throw new Error(
          `ä¸æ”¯æ´çš„æƒæå·¥å…·é¡å‹: ${options.scanner}ã€‚æ”¯æ´çš„é¡å‹: ${parserRegistry.listAvailableParsers().join(', ')}`,
        );
      }
      parserResult = { parser, scannerType: options.scanner };
      console.log(`ğŸ“‹ ä½¿ç”¨æŒ‡å®šçš„è§£æå™¨: ${options.scanner}`);
    } else {
      parserResult = parserRegistry.detectParser(reportData);
      console.log(`ğŸ” è‡ªå‹•æª¢æ¸¬åˆ°æƒæå·¥å…·: ${parserResult.scannerType}`);
    }

    // 4. è§£ææ¼æ´å ±å‘Š
    const vulnerabilities = parserResult.parser.parseReport(reportData);
    console.log(`âœ… è§£æå®Œæˆï¼Œç™¼ç¾ ${vulnerabilities.length} å€‹æ¼æ´`);

    // 5. è¼‰å…¥é…ç½®
    console.log(`ğŸ“‹ è¼‰å…¥é…ç½®æª”æ¡ˆ: ${options.config}`);
    const configLoader = new ConfigLoader();
    const config = await configLoader.loadConfig(options.config);

    // æå–å¿½ç•¥è¦å‰‡é…ç½®
    const ignoreRules = config.ignore?.rules || [];
    console.log(`âœ… è¼‰å…¥ ${ignoreRules.length} æ¢å¿½ç•¥è¦å‰‡`);

    // 6. å¥—ç”¨å¿½ç•¥è¦å‰‡ä¸¦ç”Ÿæˆæ‘˜è¦
    const ignoreFilter = new IgnoreFilter(ignoreRules);
    const processedVulnerabilities = ignoreFilter.processVulnerabilities(vulnerabilities);
    const summary = ignoreFilter.generateSummary(processedVulnerabilities);

    // 6.1. åˆå§‹åŒ–çµæœè¨˜éŒ„å™¨ä¸¦è¼¸å‡ºè™•ç†çµæœ
    const resultLogger = new ResultLogger({ verbose: options.verbose });
    resultLogger.logResults(summary, processedVulnerabilities);
    const { totalNew } = resultLogger.calculateTotals(summary);

    // 7. ç”Ÿæˆ Excel å ±å‘Š
    const outputPath = path.resolve(options.outputFile);

    console.log(`ğŸ“Š ç”Ÿæˆ Excel å ±å‘Š: ${outputPath}`);
    const excelReporter = new ExcelReporter();
    await excelReporter.generateReport(
      {
        vulnerabilities: processedVulnerabilities,
        summary,
        reportTitle: options.reporterTitle,
        detailsUrl: options.detailsUrl,
      },
      outputPath,
    );
    console.log('âœ… Excel å ±å‘Šç”Ÿæˆå®Œæˆ');

    // 8. æå–é€šçŸ¥å™¨é…ç½®ä¸¦ç™¼é€é€šçŸ¥
    const notifierConfigs = config.notify?.notifiers || [];

    // ç™¼é€é€šçŸ¥
    if (notifierConfigs.length > 0) {
      console.log('ğŸ“¢ ç™¼é€é€šçŸ¥...');
      const notifierRegistry = new NotifierRegistry();

      try {
        await notifierRegistry.sendNotifications(
          {
            summary,
            reportTitle: options.reporterTitle,
            detailsUrl: options.detailsUrl,
          },
          notifierConfigs,
        );
        console.log('âœ… æ‰€æœ‰é€šçŸ¥ç™¼é€å®Œæˆ');
      } catch (error) {
        console.error('âŒ é€šçŸ¥ç™¼é€å¤±æ•—:', error instanceof Error ? error.message : error);
        // é€šçŸ¥å¤±æ•—ä¸æ‡‰è©²è®“æ•´å€‹ç¨‹å¼ä¸­æ–·ï¼Œåªè¨˜éŒ„éŒ¯èª¤
      }
    } else {
      console.log('â„¹ï¸ æœªé…ç½®é€šçŸ¥å™¨ï¼Œè·³éé€šçŸ¥ç™¼é€');
    }

    console.log('ğŸ‰ æ‰€æœ‰ä»»å‹™å®Œæˆ!');

    // æä¾›ä½¿ç”¨çµ±è¨ˆå’Œé€€å‡ºç¢¼æ§åˆ¶
    if (totalNew > 0) {
      if (summary.critical.new > 0 || summary.high.new > 0) {
        console.log('âš ï¸  è«‹æ³¨æ„: ç™¼ç¾é«˜åš´é‡æ€§æ¼æ´ï¼Œå»ºè­°ç«‹å³è™•ç†');
        return options.exitOnHighSeverity ? false : true;
      } else {
        console.log('â„¹ï¸  ç™¼ç¾ä¸­ä½åš´é‡æ€§æ¼æ´ï¼Œå»ºè­°å®šæœŸè™•ç†');
        return true;
      }
    } else {
      console.log('âœ¨ æ­å–œ! æœªç™¼ç¾ä»»ä½•æ–°æ¼æ´');
      return true;
    }
  }
}
