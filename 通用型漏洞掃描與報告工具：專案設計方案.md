## 通用型漏洞掃描與報告工具：專案設計方案 **v2.1** 🚀

### 1. 專案願景與目標

本專案旨在打造一個**平台無關 (Platform-Agnostic)**、**可重用**且**易於維護**的自動化漏洞掃描與報告工具。我們將核心邏輯封裝成一個獨立的 CLI 工具，使其能輕易地被公司內任何專案（無論使用 GitLab、GitHub 或其他 CI/CD 平台）整合，從而建立一套標準化、高效的軟體供應鏈安全管理流程。

**核心目標：**

- **自動化 (Automation)**：在 CI/CD 流程中自動掃描專案的相依性漏洞。
- **標準化 (Standardization)**：產出格式統一的 Excel 報告與 Teams 通知。
- **通用性 (Generality)**：工具本身不與任何 CI/CD 平台強綁定，易於跨平台複用。
- **可維護性 (Maintainability)**：集中管理核心邏輯，簡化升級與維護流程。

### 2. 整體架構與工作流程

工作流程由 CI/CD 平台驅動，以我們客製化的 `vuln-reporter` CLI 工具為核心。

1. **觸發 (Trigger)**：開發者提交程式碼到特定命名規則的分支，觸發 CI/CD 管線 (Pipeline)。
2. **掃描 (Scan)**：管線中的第一步，使用 **Trivy** 掃描器分析鎖定檔 (`package-lock.json` 等)，並輸出一份結構穩定的 `trivy-report.json` 報告。
3. **執行報告工具 (Execute Reporter)**：管線下一步，透過 `npx` 指令執行我們的 `vuln-reporter` 工具，並透過命令列參數傳入上下文資訊。
4. **處理與通知 (Process & Notify)**：`vuln-reporter` 工具執行以下任務：
   - 讀取並解析 `trivy-report.json`。
   - 根據專案中的 `.vuln-ignore.yml` 檔案，過濾掉已評估的漏洞。
   - 生成一份格式化的 Excel 報告 (`vulnerability-report.xlsx`)。
   - 根據傳入的參數，向 Microsoft Teams 發送包含摘要和回溯連結的通知卡片。
5. **存檔 (Archive)**：CI/CD 管線將 Excel 報告作為產出物 (artifact) 保存，供隨時查閱。

### 3. 核心工具設計 (`vuln-reporter` CLI)

這是本方案的靈魂所在，我們將其設計為一個**開源的公開 npm 套件**，以最大化其價值與生命力。

#### 設計原則：平台無關性

為了避免與 GitLab 或任何特定平台強耦合，工具本身**不讀取任何平台特定的環境變數**。所有必要的上下文資訊（如專案名稱、Pipeline 連結）都必須透過標準的命令列參數傳入。

#### 介面設計 (Command-Line Interface)

我們可以使用 `commander.js` 或 `yargs` 來建立一個清晰的 CLI 介面。

```
# 執行範例
npx vuln-reporter@1.0.0 \
  --input "trivy-report.json" \
  --reporter-title "Scan for My Awesome Project" \
  --details-url "https://gitlab.com/your-group/your-project/-/pipelines/12345" \
  --teams-webhook-url "https://your-company.webhook.office.com/..."
```

- `--input`：Trivy 報告的 JSON 檔案路徑。
- `--reporter-title`：顯示在 Teams 通知卡片上的標題。
- `--details-url`：通知卡片上「查看詳情」按鈕的連結。
- `--teams-webhook-url`：Teams 傳入 Webhook 的 URL。

#### 技術選型 (Key Technologies)

- **命令列介面**: 使用 **`commander.js`** 來建立一個功能強大且易於使用的 CLI 介面。
- **Excel 報告生成**: 使用 **`xlsx`** (SheetJS) 函式庫，這是一個功能齊全且廣受歡迎的工具，可以輕鬆地將 JSON 資料轉換為格式化的 `.xlsx` 檔案。
- **HTTP 客戶端**: 我們將採用 **`ofetch`** 來發送通知。`ofetch` 是一個現代化、輕量級的 HTTP 客戶端，它提供了明智的預設值和優雅的錯誤處理，非常適合此類任務。
- **YAML 解析**: 使用 **`js-yaml`** 來解析 `.vuln-ignore.yml` 設定檔。

#### 功能模組

- **漏洞忽略機制 (`.vuln-ignore.yml`)**：為了更精準地管理漏洞，我們將採用結構化的 `yml` 檔案來定義忽略規則。在處理報告前，工具會讀取專案根目錄下的 `.vuln-ignore.yml` 檔案。

  **範例 `.vuln-ignore.yml`:**

  ```
  - cve: CVE-2023-12345
    package: lodash       # 可選：僅忽略特定套件中的此漏洞
    expires: '2025-09-01' # 可選：設定到期日，到期後將重新告警
    reason: '此漏洞僅影響伺服器端用法，我們未使用。'
  - cve: CVE-2023-67890
    reason: '經安全團隊確認為誤報。'
  ```

- **通知擴展性**：初期專注於實現 Teams 通知。未來可以輕易地增加 `--slack-webhook-url` 或 `--discord-webhook-url` 等參數，擴展至更多通知平台。

### 4. CI/CD 整合與部署策略

#### 觸發策略

考量到不同專案的發布流程與環境限制，我們採用一種更具彈性的**\*\*基於分支命名約定的觸發策略\*\***。團隊可以自行約定，當分支名稱包含特定關鍵字（如 `release`, `deploy`, `hotfix`）時，自動觸發漏洞掃描。這兼顧了安全性與各專案的獨特性。

#### 發佈與版本管理

- **公開發佈**：建議將 `vuln-reporter` 作為一個開源專案發佈到**公開的 npm registry**。（_註：此舉需與主管確認是否符合公司開源政策。_）
- **鎖定版本**：在所有專案的 CI/CD 腳本中，**務必鎖定 `vuln-reporter` 的具體版本號** (例如 `@1.0.0`)。這可以防止工具的破壞性更新意外地弄壞現有的 CI/CD 流程。

#### 範例 `.gitlab-ci.yml`

```
stages:
  - scan
  - report

# 第一階段：掃描
scan-vulnerabilities:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - trivy fs . --format json --output trivy-report.json --severity "CRITICAL,HIGH" --exit-code 0 --ignore-unfixed
  artifacts:
    paths:
      - trivy-report.json
    expire_in: 1 day
  rules:
    # 透過正規表示式，檢查分支名稱是否符合約定
    # 符合以下任一條件即觸發：
    # 1. 分支名稱包含 release, deploy, 或 hotfix 等關鍵字
    # 2. 分支為 main 或 master
    - if: '$CI_COMMIT_BRANCH =~ /release|deploy|hotfix/ || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'

# 第二階段：報告與通知
generate-and-notify:
  stage: report
  image: node:20
  needs:
    - scan-vulnerabilities
  script:
    # 組合平台特定的變數，並傳遞給我們的通用工具
    # 為了穩定性，鎖定工具版本為 @1.0.0
    - >
      npx vuln-reporter@1.0.0
      --input "trivy-report.json"
      --reporter-title "Vulnerability Scan for ${CI_PROJECT_NAME}"
      --details-url "${CI_SERVER_URL}/${CI_PROJECT_PATH}/-/pipelines/${CI_PIPELINE_IID}"
      --teams-webhook-url "${TEAMS_WEBHOOK_URL}"
  artifacts:
    paths:
      - vulnerability-report.xlsx
    expire_in: 7 days
  rules:
    # 規則應與掃描階段保持一致
    - if: '$CI_COMMIT_BRANCH =~ /release|deploy|hotfix/ || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
```

_註：`TEAMS_WEBHOOK_URL` 應在 GitLab 專案設定中配置為受保護的變數。_

### 5. 實施藍圖與未來展望

#### 實施藍圖

1. **階段一 (2 週)**：開發 `vuln-reporter` CLI 核心功能，包括 Trivy 解析、Excel 生成、升級後的忽略機制及 Teams 通知，並發佈 `v1.0.0` 到 npm。
2. **階段二 (1 週)**：選定 1-2 個內部專案作為試點，導入此方案，並根據回饋進行微調。
3. **階段三 (持續)**：撰寫推廣與使用文件，向公司內其他團隊推廣。

#### 未來展望

- **效能優化**：當工具被廣泛使用後，可建立一個預裝了 `vuln-reporter` 的 Docker 映像檔，以加速 CI/CD 執行。
- **數據驅動決策**：增加一個可選的數據導出功能，將每次掃描的摘要結果發送到一個中央資料庫，並建立一個儀表板來追蹤公司整體的漏洞趨勢。
- **更精細的流程控制**：未來可為 `vuln-reporter` 增加如 `--fail-on-new-critical` 的選項，當發現新的嚴重漏洞時，以非零的 exit code 中斷 CI/CD 流程，實現更嚴格的安全卡控。
- **設定檔支援**：當 CLI 參數變得複雜時，可擴充支援 `.vuln-reporterrc.json` 這類的設定檔，提供更靈活的專案級配置。
- **AI 賦能摘要**：整合大型語言模型 (LLM)，增加 `--enable-ai-summary` 功能，自動為新發現的嚴重漏洞生成中文風險說明與修復建議。

### 附錄 A：Microsoft Teams 通知卡片設計

為了讓開發者在收到通知的第一時間就能掌握關鍵資訊，我們將設計一張資訊密度更高的通知卡片。

這張卡片會包含：

1. 一個總結掃描結果的**摘要表格**。
2. 一個列出**前 3-5 個最嚴重「新發現」漏洞**的清單。

#### Adaptive Card Schema 範本

以下是一個推薦的 JSON 結構，可以直接用於發送到 Teams Webhook。`vuln-reporter` 工具的任務就是動態生成這個 JSON。

```json
{
  "type": "message",
  "attachments": [
    {
      "contentType": "application/vnd.microsoft.card.adaptive",
      "contentUrl": null,
      "content": {
        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
        "type": "AdaptiveCard",
        "version": "1.5",
        "body": [
          {
            "type": "TextBlock",
            "text": "${reporter-title}",
            "weight": "Bolder",
            "size": "Medium"
          },
          {
            "type": "TextBlock",
            "text": "在 ${CI_COMMIT_REF_NAME} 分支發現了新的潛在漏洞，請及時處理。",
            "isSubtle": true,
            "wrap": true
          },
          {
            "type": "Table",
            "columns": [{ "width": 1 }, { "width": 1 }, { "width": 1 }, { "width": 1 }],
            "rows": [
              {
                "type": "TableRow",
                "cells": [
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "嚴重性", "weight": "Bolder", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "新發現", "weight": "Bolder", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "已忽略", "weight": "Bolder", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "總計", "weight": "Bolder", "wrap": true }] }
                ],
                "style": "emphasis"
              },
              {
                "type": "TableRow",
                "cells": [
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "🔴 CRITICAL", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "2", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "1", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "3", "wrap": true }] }
                ]
              },
              {
                "type": "TableRow",
                "cells": [
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "🟠 HIGH", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "5", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "3", "wrap": true }] },
                  { "type": "TableCell", "items": [{ "type": "TextBlock", "text": "8", "wrap": true }] }
                ]
              }
            ]
          },
          {
            "type": "TextBlock",
            "text": "重點關注 (新發現的嚴重漏洞):",
            "weight": "Bolder",
            "wrap": true,
            "separator": true
          },
          {
            "type": "FactSet",
            "facts": [
              {
                "title": "CVE-2023-45678 (critical):",
                "value": "在 `some-package@1.2.3` 中發現，可能導致遠端程式碼執行。"
              },
              {
                "title": "CVE-2023-98765 (critical):",
                "value": "在 `another-lib@4.5.6` 中發現，可能導致權限提升。"
              },
              {
                "title": "CVE-2023-11223 (high):",
                "value": "在 `utility-tool@7.8.9` 中發現，可能導致阻斷服務攻擊。"
              }
            ]
          }
        ],
        "actions": [
          {
            "type": "Action.OpenUrl",
            "title": "查看完整報告 (Excel)",
            "url": "${CI_PIPELINE_URL}/artifacts/download?job=generate-and-notify"
          },
          {
            "type": "Action.OpenUrl",
            "title": "前往 CI/CD Pipeline",
            "url": "${details-url}"
          }
        ]
      }
    }
  ]
}
```
